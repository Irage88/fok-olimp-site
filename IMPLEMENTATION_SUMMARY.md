# Отчёт о реализации проекта ФОК "Олимп"

## Обзор проекта

Реализована полнофункциональная система бронирования услуг для спортивного комплекса "Олимп" с использованием современного стека технологий: Node.js + Express для backend и SQLite в качестве базы данных. Система интегрирована с существующим многостраничным статическим frontend, при этом весь пользовательский интерфейс, логика бронирования, маски ввода и макеты остались без изменений.

## Реализованный функционал

### Backend (Node.js + Express + SQLite)

#### 1. Система аутентификации
- ✅ Регистрация пользователей с полями: email, password, firstName, lastName, phone
- ✅ Вход в систему по email и password
- ✅ Генерация и валидация JWT токенов
- ✅ Хранение токенов в localStorage браузера (ключ: `token`)
- ✅ Middleware для проверки токенов на защищённых маршрутах
- ✅ Endpoint `/api/auth/me` для получения данных текущего пользователя
- ✅ Функционал выхода из системы

#### 2. Защита маршрутов
- ✅ Автоматический редирект на страницу входа при отсутствии токена
- ✅ Валидация токенов на всех защищённых маршрутах
- ✅ Автоматический редирект при невалидном или истёкшем токене

#### 3. Глобальный UI аутентификации
- ✅ Динамическое переключение кнопок в шапке сайта в зависимости от состояния авторизации
- ✅ Отображение "Войти" и "Регистрация" для неавторизованных пользователей
- ✅ Отображение "Личный кабинет" и "Выйти" для авторизованных пользователей
- ✅ Работа на всех страницах через глобальный скрипт `main.js`

#### 4. Управление профилем пользователя
- ✅ Отображение реального имени пользователя в личном кабинете
- ✅ Форма настроек для обновления email и телефона через `PATCH /api/profile`
- ✅ Валидация уникальности email при обновлении
- ✅ Сохранение изменений в базе данных

#### 5. Система бронирований
- ✅ Создание бронирования через `POST /api/bookings`
- ✅ Получение всех бронирований пользователя через `GET /api/bookings/me`
- ✅ Удаление бронирования через `DELETE /api/bookings/:id`
- ✅ Фильтрация бронирований по идентификатору авторизованного пользователя
- ✅ Сохранение формата даты: DD.MM.YYYY
- ✅ Сохранение формата времени: HH:MM

#### 6. Каталог услуг
- ✅ `GET /api/services` — получение всех услуг
- ✅ `GET /api/services/:id` — получение услуги по ID
- ✅ Заполнение базы данных услугами из существующего `servicesData.js`

#### 7. Форма обратной связи
- ✅ `POST /api/contacts` — отправка сообщений через форму контактов
- ✅ Сохранение сообщений в базе данных

#### 8. Система уведомлений
- ✅ Создание уведомлений при регистрации (приветственное сообщение)
- ✅ Создание уведомлений при создании бронирования
- ✅ Создание уведомлений при обновлении профиля
- ✅ `GET /api/notifications` — получение всех уведомлений пользователя
- ✅ `POST /api/notifications/read-all` — отметка всех уведомлений как прочитанных
- ✅ Уведомления отображаются в личном кабинете с индикацией непрочитанных
- ✅ Все уведомления привязаны к конкретному пользователю (user_id)

## Архитектурные решения

### Выбор технологий

**Backend: Node.js + Express**
- Выбран для быстрой разработки и простоты развёртывания
- Express предоставляет необходимый функционал для REST API
- Хорошая экосистема пакетов и сообщество

**База данных: SQLite**
- Не требует отдельного сервера базы данных
- Идеально подходит для небольших и средних проектов
- Простое резервное копирование (один файл)
- Легко мигрировать на PostgreSQL/MySQL при необходимости

**Аутентификация: JWT (JSON Web Tokens)**
- Stateless аутентификация — не требует хранения сессий на сервере
- Токены хранятся в localStorage клиента
- Срок действия токена: 7 дней
- Простая интеграция с frontend

### Структура проекта

```
backend/
├── src/
│   ├── server.js           # Точка входа, запуск сервера
│   ├── app.js              # Настройка Express приложения
│   ├── db/                 # Работа с базой данных
│   │   ├── db.js           # Подключение к SQLite
│   │   ├── init.js         # Скрипт инициализации БД
│   │   ├── schema.sql      # SQL схема таблиц
│   │   └── seed-services.json  # Начальные данные услуг
│   ├── routes/             # API маршруты
│   │   ├── auth.routes.js
│   │   ├── profile.routes.js
│   │   ├── services.routes.js
│   │   ├── bookings.routes.js
│   │   ├── contacts.routes.js
│   │   └── notifications.routes.js
│   ├── controllers/        # Бизнес-логика
│   │   ├── auth.controller.js
│   │   ├── profile.controller.js
│   │   ├── services.controller.js
│   │   ├── bookings.controller.js
│   │   ├── contacts.controller.js
│   │   └── notifications.controller.js
│   ├── middleware/         # Промежуточное ПО
│   │   └── auth.middleware.js  # Проверка JWT токенов
│   └── utils/              # Вспомогательные функции
│       ├── response.js     # Форматирование ответов API
│       ├── errors.js       # Обработка ошибок
│       ├── validators.js   # Валидация входных данных
│       └── notifications.js  # Утилиты для создания уведомлений
```

### Формат ответов API

Все endpoints используют единый формат ответов:

**Успешный ответ:**
```json
{
  "success": true,
  "data": { ... }
}
```

**Ошибка:**
```json
{
  "success": false,
  "error": "Сообщение об ошибке"
}
```

### Схема базы данных

- **users**: id, first_name, last_name, email, phone, password_hash, created_at
- **services**: id, title, badge, price, image, gallery_image, description, duration, format, age, level
- **bookings**: id, user_id, service_id, service_title, date (DD.MM.YYYY), time (HH:MM), status, created_at
- **contacts**: id, name, contact, message, created_at
- **notifications**: id, user_id, title, message, is_read, created_at

## Безопасность

### Реализованные меры безопасности

1. **Хеширование паролей**
   - Использование bcryptjs для хеширования паролей
   - Пароли никогда не хранятся в открытом виде

2. **JWT токены**
   - Токены имеют срок действия (7 дней)
   - Валидация токенов на всех защищённых маршрутах
   - Автоматический редирект при невалидном токене

3. **Защита маршрутов**
   - Все операции с бронированиями требуют авторизации
   - Пользователь может видеть и изменять только свои бронирования
   - Обновление профиля доступно только авторизованным пользователям

4. **Валидация данных**
   - Проверка уникальности email при регистрации и обновлении
   - Валидация форматов даты и времени
   - Проверка обязательных полей на всех endpoints

5. **Изоляция данных**
   - Фильтрация бронирований по user_id из токена
   - Невозможность доступа к данным других пользователей

## Поток бронирования

1. **Просмотр услуг:** Пользователь просматривает каталог услуг на странице `/services.html`
2. **Выбор услуги:** Переход на страницу конкретной услуги `/service.html?id=<service_id>`
3. **Создание бронирования:** Заполнение формы с датой (DD.MM.YYYY) и временем (HH:MM)
4. **Отправка запроса:** POST запрос на `/api/bookings` с данными бронирования
5. **Сохранение в БД:** Бронирование сохраняется с привязкой к user_id из JWT токена
6. **Отображение в кабинете:** Бронирование появляется в личном кабинете пользователя

## Поток обновления профиля

1. **Доступ к настройкам:** Пользователь открывает личный кабинет `/dashboard`
2. **Заполнение формы:** Ввод нового email или телефона в форме настроек
3. **Валидация:** Проверка уникальности email (если изменяется)
4. **Отправка запроса:** PATCH запрос на `/api/profile` с обновлёнными данными
5. **Обновление БД:** Данные обновляются в таблице users
6. **Создание уведомления:** Система создаёт уведомление об успешном обновлении профиля
7. **Отображение изменений:** Обновлённые данные отображаются в интерфейсе

## Поток работы с уведомлениями

1. **Создание уведомлений:** Система автоматически создаёт уведомления при:
   - Регистрации нового пользователя (приветственное сообщение)
   - Создании бронирования (подтверждение бронирования)
   - Обновлении профиля (подтверждение изменения email/телефона)

2. **Отображение уведомлений:** При загрузке личного кабинета:
   - Frontend запрашивает уведомления через `GET /api/notifications`
   - Уведомления отображаются в разделе "Уведомления"
   - Непрочитанные уведомления помечаются индикатором "●" и значком "новое"

3. **Отметка как прочитанные:** Пользователь может:
   - Использовать кнопку "Отметить все" для массовой отметки
   - Система отправляет `POST /api/notifications/read-all`
   - Все уведомления пользователя помечаются как прочитанные (is_read = 1)

## Сохранённые возможности

При интеграции backend с существующим frontend были сохранены все оригинальные возможности:

- ✅ Все HTML/CSS макеты остались без изменений
- ✅ Маски ввода даты (DD.MM.YYYY) и времени (HH:MM) работают как прежде
- ✅ Модальное окно оплаты сохранено
- ✅ Все существующие валидации форм работают
- ✅ Все ресурсы (изображения, шрифты) остались в `/frontend/assets`
- ✅ Вся существующая UX логика сохранена

## Развёртывание

### Render (Free Plan)
- Проект развёрнут и работает на Render Free Plan
- Использует чистые URL без расширения `.html`
- API базовый URL определяется автоматически на основе домена
- База данных автоматически инициализируется при каждом запуске
- **Ограничение Free Plan:** Нет Persistent Disk, данные не сохраняются между перезапусками

### Автоматическая инициализация БД
- При каждом запуске сервера автоматически:
  - Проверяется наличие таблиц (CREATE TABLE IF NOT EXISTS)
  - Заполняются услуги, если таблица services пуста
  - Это обеспечивает работу на Render Free Plan без ручной настройки

## Будущие улучшения

### Развёртывание и хостинг
- Переход на Render Paid Plan с Persistent Disk для сохранения данных
- Использование PostgreSQL или MySQL для production окружения
- Настройка резервного копирования базы данных
- Настройка CI/CD для автоматического развёртывания

### Интеграция платежей
- Интеграция платёжных систем (Stripe, PayPal, ЮKassa)
- Обработка платежей за бронирования
- История транзакций в личном кабинете
- Возврат средств при отмене бронирования

### Расширение системы уведомлений
- Email уведомления о подтверждении бронирования
- Напоминания о предстоящих бронированиях
- Уведомления об изменениях статуса бронирования
- SMS уведомления (опционально)
- Push-уведомления в браузере

### Административная панель
- Панель администратора для управления бронированиями
- Просмотр всех пользователей и их бронирований
- Управление услугами (добавление, редактирование, удаление)
- Статистика и аналитика по бронированиям
- Управление сообщениями из формы контактов

### Дополнительные функции
- Календарь доступности услуг
- Система рейтингов и отзывов
- Интеграция с календарём (Google Calendar, iCal)
- Экспорт бронирований в PDF
- Многоязычность интерфейса

